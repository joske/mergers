name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to update formula to (e.g., v0.2.0)"
        required: true

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Wait for macOS release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          for i in $(seq 1 30); do
            ASSETS=$(gh release view "$TAG" --repo joske/mergers --json assets -q '.assets[].name')
            if echo "$ASSETS" | grep -q "mergers-darwin-aarch64.tar.gz"; then
              echo "macOS asset found"
              exit 0
            fi
            echo "Waiting for macOS asset... attempt $i/30"
            sleep 60
          done
          echo "Timed out waiting for macOS asset"
          exit 1

      - name: Compute SHA256 checksum
        id: sha
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          URL="https://github.com/joske/mergers/releases/download/${TAG}/mergers-darwin-aarch64.tar.gz"
          SHA=$(curl -sL "$URL" | shasum -a 256 | cut -d' ' -f1)
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v6
        with:
          repository: joske/homebrew-mergers
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          SHA: ${{ steps.sha.outputs.sha }}
        run: |
          cat > Formula/mergers.rb << 'FORMULA'
          class Mergers < Formula
            desc "Visual diff and merge tool written in Rust with GTK4"
            homepage "https://github.com/joske/mergers"
          FORMULA
          cat >> Formula/mergers.rb << FORMULA
            version "${VERSION}"
            license "GPL-2.0-only"
            url "https://github.com/joske/mergers/releases/download/${TAG}/mergers-darwin-aarch64.tar.gz"
            sha256 "${SHA}"
          FORMULA
          cat >> Formula/mergers.rb << 'FORMULA'

            depends_on :macos
            depends_on "gtk4"
            depends_on "gtksourceview5"

            def install
              bin.install "mergers"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/mergers --version")
            end
          end
          FORMULA

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/mergers.rb
          git commit -m "Update mergers to ${{ steps.version.outputs.tag }}"
          git push
